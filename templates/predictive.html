<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <title>Predictive Analysis | AstraSemi</title>
    <style>
        .health-excellent { background-color: #198754 !important; }
        .health-good { background-color: #6c757d !important; }
        .health-warning { background-color: #ffc107 !important; color: #000 !important; }
        .health-danger { background-color: #dc3545 !important; }

        .machine-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .machine-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .risk-low { background-color: #198754; }
        .risk-medium { background-color: #ffc107; }
        .risk-high { background-color: #dc3545; }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .stats-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: none;
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-dark text-light">

    <nav class="navbar border-bottom border-secondary p-3">
        <div class="container-fluid">
            <a href="/" class="text-decoration-none"><span class="text-primary fw-bold">← BACK TO HUB</span></a>
            <span class="navbar-text text-white fw-bold"><i class="bi bi-graph-up-arrow me-2"></i>PREDICTIVE ANALYSIS</span>
        </div>
    </nav>

    <div class="container py-4">

        <!-- CSV Upload Section -->
        <div class="card mb-4 border-dashed bg-black p-4 text-center shadow-lg" style="border: 2px dashed #30363d;">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="fs-3 text-primary me-3"><i class="bi bi-cloud-arrow-up"></i></div>
                            <div class="text-start">
                                <h5 class="text-white mb-1">Upload Equipment Data</h5>
                                <p class="text-secondary small mb-0">Select a CSV file with equipment data for predictive analysis</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="file" id="csvFile" class="form-control bg-dark text-white border-secondary" accept=".csv" required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload me-2"></i>Upload
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Content shown conditionally based on data availability -->
        <div id="dashboardContent" style="display: none;">
        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-cpu fs-2 mb-2"></i>
                        <h3 class="mb-1" id="totalMachines">-</h3>
                        <p class="mb-0 small">Total Machines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle fs-2 mb-2 text-warning"></i>
                        <h3 class="mb-1" id="highRiskCount">-</h3>
                        <p class="mb-0 small">High Risk</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-heart-pulse fs-2 mb-2 text-success"></i>
                        <h3 class="mb-1" id="avgHealthScore">-</h3>
                        <p class="mb-0 small">Avg Health Score</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-white h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-clock fs-2 mb-2 text-info"></i>
                        <h3 class="mb-1" id="lastUpdated">-</h3>
                        <p class="mb-0 small">Last Updated</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8 mb-3">
                <div class="card border-secondary bg-dark">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-white"><i class="bi bi-graph-up me-2"></i>Failure Probability Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-secondary bg-dark">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-white"><i class="bi bi-pie-chart me-2"></i>Risk Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Machine List -->
        <div class="row">
            <div class="col-12">
                <div class="card border-secondary bg-dark">
                    <div class="card-header bg-dark border-secondary">
                        <h5 class="mb-0 text-white"><i class="bi bi-list-ul me-2"></i>Equipment Status</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Machine ID</th>
                                        <th>Health Score</th>
                                        <th>Failure Risk</th>
                                        <th>Runtime (hrs)</th>
                                        <th>Temperature (°C)</th>
                                        <th>Vibration</th>
                                        <th>Errors</th>
                                        <th>Maintenance Due</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="equipmentTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 mb-0">Loading equipment data...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- No data uploaded message -->
        <div id="noDataMessage" class="row">
            <div class="col-12">
                <div class="card border-secondary bg-dark text-center py-5">
                    <div class="fs-1 text-muted mb-3">
                        <i class="bi bi-cloud-arrow-up"></i>
                    </div>
                    <h4 class="text-muted mb-2">No Equipment Data Available</h4>
                    <p class="text-secondary">Upload a CSV file containing equipment data to see predictive maintenance analysis.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysisModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">
                        <i class="bi bi-robot me-2"></i>
                        <span id="modalMachineId">Equipment Analysis</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="analysisContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <p class="mt-2 mb-0">Running AI analysis...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 text-secondary small border-top border-secondary mt-5">
        AstraSemi Intelligence System • Module 4 • v1.0
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let trendsChart, riskChart;
        let equipmentData = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupUploadForm();
            // Don't load data automatically - only show upload interface
        });

        // Setup upload form
        function setupUploadForm() {
            const form = document.getElementById('uploadForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                uploadCSVFile();
            });
        }

        // Upload CSV file
        async function uploadCSVFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', file);

            try {
                // Show loading state
                document.getElementById('noDataMessage').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Clear existing data
                document.getElementById('totalMachines').textContent = '-';
                document.getElementById('highRiskCount').textContent = '-';
                document.getElementById('avgHealthScore').textContent = '-';
                document.getElementById('lastUpdated').textContent = '-';
                document.getElementById('equipmentTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Processing uploaded CSV...</span>
                            </div>
                            <p class="mt-2 mb-0">Processing equipment data...</p>
                        </td>
                    </tr>
                `;

                const response = await fetch('/api/predictive-data', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                equipmentData = data.equipment;
                updateSummaryCards(data.summary);
                updateEquipmentTable(data.equipment);
                updateCharts(data.trends, data.equipment);

            } catch (error) {
                console.error('Error uploading CSV:', error);
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('dashboardContent').style.display = 'none';
                alert(`Failed to process CSV file: ${error.message}`);
            }
        }

        // Load all data
        async function loadData() {
            try {
                const response = await fetch('/api/predictive-data');
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.equipment.length > 0) {
                    equipmentData = data.equipment;
                    document.getElementById('noDataMessage').style.display = 'none';
                    document.getElementById('dashboardContent').style.display = 'block';

                    updateSummaryCards(data.summary);
                    updateEquipmentTable(data.equipment);
                    updateCharts(data.trends, data.equipment);
                }

            } catch (error) {
                console.error('Error loading data:', error);
                // Keep the no data message visible on error
            }
        }

        // Update summary cards
        function updateSummaryCards(summary) {
            document.getElementById('totalMachines').textContent = summary.total_machines;
            document.getElementById('highRiskCount').textContent = summary.high_risk_count;
            document.getElementById('avgHealthScore').textContent = summary.average_health_score;
            document.getElementById('lastUpdated').textContent = new Date(summary.last_updated).toLocaleTimeString();
        }

        // Update equipment table
        function updateEquipmentTable(equipment) {
            const tbody = document.getElementById('equipmentTableBody');
            tbody.innerHTML = '';

            equipment.forEach(machine => {
                const row = document.createElement('tr');
                const riskClass = machine.failure_probability > 0.7 ? 'high' :
                                 machine.failure_probability > 0.4 ? 'medium' : 'low';
                const healthClass = machine.health_score > 80 ? 'excellent' :
                                   machine.health_score > 60 ? 'good' :
                                   machine.health_score > 40 ? 'warning' : 'danger';

                const daysColor = machine.days_to_maintenance <= 7 ? 'text-danger' :
                                 machine.days_to_maintenance <= 30 ? 'text-warning' : 'text-success';

                row.innerHTML = `
                    <td><code>${machine.machine_id}</code></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                <div class="progress-bar health-${healthClass}" style="width: ${machine.health_score}%">
                                    ${machine.health_score}%
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="risk-indicator risk-${riskClass}"></span>
                        ${(machine.failure_probability * 100).toFixed(1)}%
                    </td>
                    <td>${machine.runtime_hours.toLocaleString()}</td>
                    <td>${machine.temperature}°C</td>
                    <td>${machine.vibration}</td>
                    <td>
                        ${machine.error_count > 0 ?
                            `<span class="badge bg-warning text-dark">${machine.error_count}</span>` :
                            '<span class="text-success">None</span>'}
                    </td>
                    <td class="${daysColor}">
                        ${machine.recommended_maintenance} (${machine.days_to_maintenance} days)
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="analyzeMachine('${machine.machine_id}')">
                            <i class="bi bi-search"></i> Analyze
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Update charts
        function updateCharts(trends, equipment) {
            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');

            if (trendsChart) {
                trendsChart.destroy();
            }

            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: trends.map(t => t.month),
                    datasets: [{
                        label: 'Failure Probability',
                        data: trends.map(t => t.avg_failure_probability),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Incidents',
                        data: trends.map(t => t.incidents),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' },
                            title: {
                                display: true,
                                text: 'Failure Probability',
                                color: '#ffffff'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#ffffff' },
                            grid: { drawOnChartArea: false },
                            title: {
                                display: true,
                                text: 'Incidents',
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');

            if (riskChart) {
                riskChart.destroy();
            }

            const riskCounts = {
                low: equipment.filter(m => m.failure_probability <= 0.4).length,
                medium: equipment.filter(m => m.failure_probability > 0.4 && m.failure_probability <= 0.7).length,
                high: equipment.filter(m => m.failure_probability > 0.7).length
            };

            riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        data: [riskCounts.low, riskCounts.medium, riskCounts.high],
                        backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#1a1a1a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // Analyze specific machine
        async function analyzeMachine(machineId) {
            const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
            document.getElementById('modalMachineId').textContent = `Analysis: ${machineId}`;
            document.getElementById('analysisContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Analyzing...</span>
                    </div>
                    <p class="mt-2 mb-0">Running AI analysis...</p>
                </div>
            `;

            modal.show();

            try {
                const response = await fetch('/api/predictive-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ machine_id: machineId })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                document.getElementById('analysisContent').innerHTML = `
                    <div class="analysis-text" style="line-height: 1.8;">
                        ${data.analysis_html}
                    </div>
                `;

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('analysisContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Show error message
        function showError(message) {
            const tbody = document.getElementById('equipmentTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            ${message}
                        </div>
                    </td>
                </tr>
            `;
        }
    </script>
</body>
</html>